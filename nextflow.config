// ============================================================================
// Nextflow Configuration for scRNA-seq Pipeline
// ============================================================================

// General parameters
params {
    // Input/Output
    outdir              = "${launchDir}/results"
    samplesheet         = null
    fasta               = null
    annotation          = null

    // Pipeline control
    run_mode            = "all"  // Options: all, index_only, quant_only, qc_only, integration_only

    // Container images
    simpleaf_image      = "quay.io/biocontainers/simpleaf:0.19.5--ha6fb395_0"
    scanpy_image        = "gcfntnu/scanpy:1.11.4"

    // QC parameters (can be overridden by qc_config.json)
    min_genes_per_cell      = 200
    max_genes_per_cell      = null
    min_counts_per_cell     = 500
    max_counts_per_cell     = null
    max_pct_mt              = 20
    min_cells_per_gene      = 3
    mt_prefix               = "MT-"
    run_doublets            = true
    n_hvgs                  = 3000
    n_pcs                   = 50

    // BBKNN parameters (can be overridden by bbknn_config.json)
    bbknn_batch_key              = "batch"
    bbknn_neighbors_within_batch = 3
    bbknn_n_pcs                  = 50
    leiden_resolution            = 1.0

    // Config file paths
    qc_config               = "${projectDir}/assets/qc_config.json"
    bbknn_config            = "${projectDir}/assets/bbknn_config.json"
}

// Process resource allocation
process {
    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
        mode: 'copy',
        saveAs: { filename -> filename }
    ]

    withName: SIMPLEAF_INDEX {
        cpus   = 4
        memory = 8.GB
        time   = 4.h
        container = params.simpleaf_image
    }

    withName: SIMPLEAF_QUANT {
        cpus   = 8
        memory = 16.GB
        time   = 12.h
        container = params.simpleaf_image
    }

    withName: SCANPY_QC {
        cpus   = 8
        memory = 16.GB
        time   = 2.h
        container = params.scanpy_image
    }

    withName: SCANPY_BBKNN {
        cpus   = 8
        memory = 32.GB
        time   = 4.h
        container = params.scanpy_image
    }

    withName: PARSE_SAMPLESHEET {
        cpus   = 2
        memory = 4.GB
        time   = 10.m
    }
}

// Profiles for different executors
profiles {
    local {
        executor {
            name = 'local'
            queueSize = 4
        }
    }

    slurm {
        executor {
            name = 'slurm'
            queueSize = 100
            submitRateLimit = '10 sec'
        }
    }

    test {
        includeConfig 'conf/test.config'
    }
}

// Docker/Singularity settings
docker {
    enabled = true
}

singularity {
    enabled = false
    autoMounts = true
}

// Trace and timeline reports
trace {
    enabled = true
    file = "${params.outdir}/reports/execution_trace.txt"
    fields = 'process,task_id,name,status,exit,submit,start,complete,duration,realtime,%cpu,%mem,rss,vmem'
}

timeline {
    enabled = true
    file = "${params.outdir}/reports/execution_timeline.html"
}

// Manifest
manifest {
    name            = 'Nextflow scRNA-seq Pipeline'
    description     = 'Modular Nextflow DSL2 pipeline for 10x scRNA-seq analysis'
    homePage        = 'https://github.com/'
    author          = 'Your Name'
    version         = '1.0.0'
    nextflowVersion = '>=23.0.0'
}
